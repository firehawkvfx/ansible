- name: 'create a new ebs volume'
  debug:
    msg: "create a new ebs volume {{ item.item.int }} {{ item.item.path }}"

- name: show common_tags
  debug:
    var: common_tags

- name: add new key / value pairs to dict to combine dict.
  set_fact:
    common_tags: "{{ common_tags | combine({item.key: item.value}) }}"
  with_items:
  - { key: 'mount', value: '{{ item.item.path }}' }
  - { key: 'pool', value: '{{ item.item.pool_name }}' }
  - { key: 'volatile', value: '{{ item.item.volatile }}' }

- name: show common_tags
  debug:
    var: common_tags

- name: common_tags iterate
  debug:
    var: "{{ item }}"
  with_dict: "{{ common_tags }}"

- name: create ebs volume
  ec2_vol:
    region: "{{ aws_region }}"
    instance: "{{ instance_id }}"
    name: "softnas_volume_{{ item.item.int }}"
    volume_size: "{{ item.item.ebs_disk_size }}"
    volume_type: "{{ item.item.ebs_disk_type }}"
    device_name: "{{ item.item.path }}"
    delete_on_termination: "{{ item.item.volatile }}"
    # tags: common_tags
  register: new_vol

- name: show new_vol
  debug:
    var: new_vol

# - name: Ensure all volumes are tagged
#   ec2_tag:
#     region:  eu-west-1
#     resource: '{{ ec2_vol.volumes[0] }}'
#     state: present
#     tags:
#       Name: dbserver
#       Env: production